<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gasolineras y Cargadores - EspaÃ±a</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.min.css"/>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;overflow:hidden}
#map{height:100vh;width:100%;position:fixed;top:0;left:0;z-index:1}
.sidebar{position:fixed;left:0;top:0;width:400px;height:100vh;background:white;box-shadow:2px 0 10px rgba(0,0,0,.2);z-index:1000;display:flex;flex-direction:column}
.sidebar-scroll{flex:1;overflow-y:auto}
@media(max-width:768px){
.sidebar{width:100%;height:50vh;top:auto;bottom:0}
#map{height:50vh}
}
</style>
</head>

<body>
<div id="map"></div>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

let map=null, cluster=null, userMark=null;

const App = () => {
  const [gas,setGas]=useState([]);
  const [items,setItems]=useState([]);
  const [loading,setLoading]=useState(true);
  const [search,setSearch]=useState('');
  const [fuel,setFuel]=useState('Precio Gasolina 95 E5');

  useEffect(()=>{
    if(!map){
      map=L.map('map').setView([40.4,-3.7],7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
      cluster=L.markerClusterGroup({maxClusterRadius:50});
      map.addLayer(cluster);
      setTimeout(()=>map.invalidateSize(),200);
    }
    fetchGas();
    getLoc();
  },[]);

  const fetchGas = async () => {
    const r = await fetch(
      'https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/'
    );
    const d = await r.json();
    const g = d.ListaEESSPrecio.map(s=>({
      id:s.IDEESS,
      name:s['RÃ³tulo'],
      town:s['Municipio'],
      prov:s['Provincia'],
      lat:parseFloat(s['Latitud'].replace(',','.')),
      lng:parseFloat(s['Longitud (WGS84)'].replace(',','.')),
      price:parseFloat(s[fuel]?.replace(',','.'))||null
    }));
    setGas(g);
    setItems(g);
    setLoading(false);
  };

  const getLoc = () => {
    navigator.geolocation?.getCurrentPosition(p=>{
      const l={lat:p.coords.latitude,lng:p.coords.longitude};
      map.setView([l.lat,l.lng],11);
      userMark=L.marker([l.lat,l.lng]).addTo(map).bindPopup('ðŸ“ TÃº');
    });
  };

  useEffect(()=>{
    if(!cluster) return;
    cluster.clearLayers();
    items.forEach(i=>{
      if(!i.lat||!i.lng) return;
      const m=L.marker([i.lat,i.lng]).bindPopup(
        `<strong>${i.name}</strong><br>${i.town} (${i.prov})<br>${i.price?.toFixed(3)} â‚¬/L`
      );
      cluster.addLayer(m);
    });
  },[items]);

  useEffect(()=>{
    let res=[...gas];
    if(search){
      res=res.filter(i=>
        i.name?.toLowerCase().includes(search.toLowerCase())||
        i.town?.toLowerCase().includes(search.toLowerCase())
      );
    }
    setItems(res);
  },[search,gas]);

  if(loading){
    return <div className="sidebar flex items-center justify-center">Cargandoâ€¦</div>;
  }

  return (
    <div className="sidebar">
      <div className="p-4 border-b">
        <input
          className="w-full border p-2 rounded"
          placeholder="Buscar gasolinera o ciudad"
          value={search}
          onChange={e=>setSearch(e.target.value)}
        />
      </div>

      <div className="sidebar-scroll">
        {items.map(i=>(
          <div key={i.id} className="p-4 border-b text-sm">
            <strong>{i.name}</strong>
            <div className="text-xs text-gray-600">{i.town} Â· {i.prov}</div>
            {i.price && (
              <div className="font-bold mt-1">
                {i.price.toFixed(3)} â‚¬/L
              </div>
            )}
          </div>
        ))}
      </div>
    </div>
  );
};

ReactDOM.render(<App/>, document.getElementById('root'));
</script>
</body>
</html>
