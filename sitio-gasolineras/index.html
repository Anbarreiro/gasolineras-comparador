<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gasolineras y Cargadores - España</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.min.css"/>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;overflow:hidden}
#map{height:100vh;width:100%;position:fixed;top:0;left:0;z-index:1}
.sidebar{position:fixed;left:0;top:0;width:400px;height:100vh;background:white;box-shadow:2px 0 10px rgba(0,0,0,.2);z-index:1000;display:flex;flex-direction:column}
.comparator-panel{position:fixed;right:0;top:0;width:450px;height:100vh;background:white;box-shadow:-2px 0 10px rgba(0,0,0,.2);z-index:1001;display:flex;flex-direction:column;transform:translateX(100%);transition:.3s}
.comparator-panel.open{transform:translateX(0)}
.sidebar-scroll{flex:1;overflow-y:auto}
.selected-for-compare{background:#dbeafe!important;border-left:4px solid #2563eb!important}
@media(max-width:768px){
  .sidebar{width:100%;height:50vh;top:auto;bottom:0}
  .comparator-panel{width:100%;height:70vh}
  #map{height:50vh}
}
</style>
</head>

<body>
<div id="map"></div>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;
let map=null, cluster=null, userMark=null;

/* ========= APP ========= */
const App = () => {
  const [gas,setGas]=useState([]);
  const [elec,setElec]=useState([]);
  const [items,setItems]=useState([]);
  const [load,setLoad]=useState(true);
  const [err,setErr]=useState(null);
  const [mode,setMode]=useState('gas');
  const [fuel,setFuel]=useState('Precio Gasolina 95 E5');
  const [search,setSearch]=useState('');
  const [sort,setSort]=useState('price');
  const [loc,setLoc]=useState(null);
  const [prov,setProv]=useState('');
  const [stats,setStats]=useState({min:0,max:0,avg:0});
  const [mapOk,setMapOk]=useState(false);
  const [comp,setComp]=useState(false);
  const [sel,setSel]=useState([]);

  const fuels=[
    'Precio Gasolina 95 E5',
    'Precio Gasolina 98 E5',
    'Precio Gasoleo A',
    'Precio Gasoleo B',
    'Precio Gasoleo Premium'
  ];

  useEffect(()=>{
    if(!map){
      map=L.map('map').setView([40.4,-3.7],7);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
      cluster=L.markerClusterGroup({maxClusterRadius:50});
      map.addLayer(cluster);
      setTimeout(()=>{map.invalidateSize();setMapOk(true)},200);
    }
    fetchGas();
    fetchElec();
    getLoc();
  },[]);

  const fetchGas=async()=>{
    try{
      setLoad(true);
      const r=await fetch('https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/');
      const d=await r.json();
      setGas(d.ListaEESSPrecio.map(s=>({
        id:'g-'+s.IDEESS,
        type:'gas',
        name:s['Rótulo'],
        town:s['Municipio'],
        prov:s['Provincia'],
        lat:+s['Latitud'].replace(',','.'),
        lng:+s['Longitud (WGS84)'].replace(',','.'),
        p:{[fuel]:+s[fuel]?.replace(',','.')}
      })));
      setLoad(false);
    }catch{ setErr('Error cargando gasolineras'); }
  };

  const fetchElec=async()=>{
    const r=await fetch('https://api.openchargemap.io/v3/poi/?output=json&countrycode=ES&maxresults=2000');
    setElec(await r.json());
  };

  const getLoc=()=>{
    navigator.geolocation?.getCurrentPosition(p=>{
      const l={lat:p.coords.latitude,lng:p.coords.longitude};
      setLoc(l);
      map?.setView([l.lat,l.lng],11);
    });
  };

  if(load) return <div className="sidebar flex items-center justify-center">Cargando…</div>;
  if(err) return <div className="sidebar">{err}</div>;

  return (
    <div className="sidebar">
      <div className="p-4 font-bold bg-blue-600 text-white">Gasolineras</div>
      <div className="sidebar-scroll p-4">
        {items.length || 'Datos cargados correctamente ✅'}
      </div>
      <Comp stations={sel} fuel={fuel} loc={loc} onClose={()=>setSel([])} />
    </div>
  );
};

/* ========= COMPARADOR ========= */
const Comp = ({stations,fuel,loc,onClose}) => {
  if(stations.length!==2) return null;
  return (
    <div className={`comparator-panel open rounded-lg shadow-lg p-4 bg-white`}>
      <button onClick={onClose}>Cerrar</button>
    </div>
  );
};

ReactDOM.render(<App/>, document.getElementById('root'));
</script>
</body>
</html>
