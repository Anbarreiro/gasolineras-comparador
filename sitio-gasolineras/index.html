<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gasolineras Espa√±a - Comparador + El√©ctrico</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;overflow:hidden}
#map{height:100vh;width:100%;position:fixed;top:0;left:0;z-index:1}
.sidebar{position:fixed;left:0;top:0;width:400px;height:100vh;background:white;box-shadow:2px 0 10px rgba(0,0,0,.2);z-index:1000;display:flex;flex-direction:column}
.comparator-panel{position:fixed;right:0;top:0;width:450px;height:100vh;background:white;box-shadow:-2px 0 10px rgba(0,0,0,.2);z-index:1001;display:flex;flex-direction:column;transform:translateX(100%);transition:.3s}
.comparator-panel.open{transform:translateX(0)}
.sidebar-scroll{flex:1;overflow-y:auto}
.selected-for-compare{background:#dbeafe!important;border-left:4px solid #2563eb!important}
@media(max-width:768px){
.sidebar{width:100%;height:50vh;top:auto;bottom:0}
.comparator-panel{width:100%;height:70vh}
#map{height:50vh}
}
</style>
</head>

<body>
<div id="map"></div>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect}=React;
let map=null,cluster=null,userMarker=null;

const App=()=>{
const[stations,setStations]=useState([]);
const[chargers,setChargers]=useState([]);
const[items,setItems]=useState([]);
const[loading,setLoading]=useState(true);
const[error,setError]=useState(null);
const[mode,setMode]=useState('gas');
const[fuel,setFuel]=useState('Precio Gasolina 95 E5');
const[search,setSearch]=useState('');
const[sort,setSort]=useState('price');
const[userLoc,setUserLoc]=useState(null);
const[prov,setProv]=useState('');
const[compare,setCompare]=useState(false);
const[selected,setSelected]=useState([]);

const fuels=[
'Precio Gasolina 95 E5',
'Precio Gasolina 98 E5',
'Precio Gasoleo A',
'Precio Gasoleo B',
'Precio Gasoleo Premium'
];

useEffect(()=>{
if(!map){
map=L.map('map').setView([40.4,-3.7],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
cluster=L.markerClusterGroup({maxClusterRadius:50});
map.addLayer(cluster);
setTimeout(()=>map.invalidateSize(),200);
}
loadGas();
loadElec();
locateUser();
},[]);

const loadGas=async()=>{
try{
const r=await fetch('https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/');
const d=await r.json();
setStations(d.ListaEESSPrecio.map(s=>({
id:'g-'+s.IDEESS,
type:'gas',
name:s['R√≥tulo'],
town:s['Municipio'],
prov:s['Provincia'],
lat:+s['Latitud'].replace(',','.'),
lng:+s['Longitud (WGS84)'].replace(',','.'),
prices:{
'Precio Gasolina 95 E5':+s['Precio Gasolina 95 E5']?.replace(',','.'),
'Precio Gasolina 98 E5':+s['Precio Gasolina 98 E5']?.replace(',','.'),
'Precio Gasoleo A':+s['Precio Gasoleo A']?.replace(',','.'),
'Precio Gasoleo B':+s['Precio Gasoleo B']?.replace(',','.'),
'Precio Gasoleo Premium':+s['Precio Gasoleo Premium']?.replace(',','.')
}
})));
setLoading(false);
}catch{setError('Error cargando gasolineras')}
};

const loadElec=async()=>{
const r=await fetch('https://api.openchargemap.io/v3/poi/?output=json&countrycode=ES&maxresults=2000');
const d=await r.json();
setChargers(d.map(c=>({
id:'e-'+c.ID,
type:'elec',
name:c.AddressInfo?.Title,
town:c.AddressInfo?.Town,
prov:c.AddressInfo?.StateOrProvince,
lat:c.AddressInfo?.Latitude,
lng:c.AddressInfo?.Longitude
})));
};

const locateUser=()=>{
navigator.geolocation?.getCurrentPosition(p=>{
const l={lat:p.coords.latitude,lng:p.coords.longitude};
setUserLoc(l);
map.setView([l.lat,l.lng],11);
if(userMarker)userMarker.remove();
userMarker=L.marker([l.lat,l.lng]).addTo(map);
});
};

const dist=(a,b,c,d)=>{
const R=6371;
const dLat=(c-a)*Math.PI/180;
const dLng=(d-b)*Math.PI/180;
const h=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2;
return R*2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
};

/* üîß FILTRADO CORREGIDO */
useEffect(()=>{
let res=[];

if(mode==='gas'||mode==='both'){
let g=[...stations];

if(search){
g=g.filter(s=>
s.name?.toLowerCase().includes(search.toLowerCase()) ||
s.town?.toLowerCase().includes(search.toLowerCase())
);
}

if(prov){
g=g.filter(s=>s.prov===prov);
}

g=g.filter(s=>typeof s.prices?.[fuel]==='number' &&
