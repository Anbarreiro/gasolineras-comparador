<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gasolineras España - Comparador + Eléctrico</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.min.js"></script>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;overflow:hidden}
#map{height:100vh;width:100%;position:fixed;top:0;left:0;z-index:1}
.sidebar{position:fixed;left:0;top:0;width:400px;height:100vh;background:white;box-shadow:2px 0 10px rgba(0,0,0,.2);z-index:1000;display:flex;flex-direction:column}
.comparator-panel{position:fixed;right:0;top:0;width:450px;height:100vh;background:white;box-shadow:-2px 0 10px rgba(0,0,0,.2);z-index:1001;display:flex;flex-direction:column;transform:translateX(100%);transition:.3s}
.comparator-panel.open{transform:translateX(0)}
.sidebar-scroll{flex:1;overflow-y:auto}
.selected-for-compare{background:#dbeafe!important;border-left:4px solid #2563eb!important}
.toggle-btn{padding:.5rem 1rem;border-radius:.5rem;font-size:.875rem;font-weight:500}
.toggle-btn.active{background:#2563eb;color:white}
.toggle-btn.inactive{background:#e5e7eb;color:#6b7280}
@media(max-width:768px){
.sidebar{width:100%;height:50vh;top:auto;bottom:0}
.comparator-panel{width:100%;height:70vh}
#map{height:50vh}
}
</style>
</head>

<body>
<div id="map"></div>
<div id="root"></div>

<script type="text/babel">
const {useState,useEffect}=React;
let map=null,cluster=null,userMarker=null;

const App=()=>{
const[stations,setStations]=useState([]);
const[chargers,setChargers]=useState([]);
const[items,setItems]=useState([]);
const[loading,setLoading]=useState(true);
const[error,setError]=useState(null);
const[mode,setMode]=useState('gas');
const[fuel,setFuel]=useState('Precio Gasolina 95 E5');
const[search,setSearch]=useState('');
const[sort,setSort]=useState('price');
const[userLoc,setUserLoc]=useState(null);
const[prov,setProv]=useState('');
const[stats,setStats]=useState({min:0,max:0,avg:0});
const[mapReady,setMapReady]=useState(false);
const[compare,setCompare]=useState(false);
const[selected,setSelected]=useState([]);

const fuels=[
'Precio Gasolina 95 E5',
'Precio Gasolina 98 E5',
'Precio Gasoleo A',
'Precio Gasoleo B',
'Precio Gasoleo Premium'
];

useEffect(()=>{
if(!map){
map=L.map('map').setView([40.4,-3.7],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
cluster=L.markerClusterGroup({maxClusterRadius:50});
map.addLayer(cluster);
setTimeout(()=>{map.invalidateSize();setMapReady(true)},200);
}
loadGas();
loadElec();
locateUser();
},[]);

const loadGas=async()=>{
try{
const r=await fetch('https://sedeaplicaciones.minetur.gob.es/ServiciosRESTCarburantes/PreciosCarburantes/EstacionesTerrestres/');
const d=await r.json();
setStations(d.ListaEESSPrecio.map(s=>({
id:'g-'+s.IDEESS,
type:'gas',
name:s['Rótulo'],
addr:s['Dirección'],
town:s['Municipio'],
prov:s['Provincia'],
lat:+s['Latitud'].replace(',','.'),
lng:+s['Longitud (WGS84)'].replace(',','.'),
prices:{
'Precio Gasolina 95 E5':+s['Precio Gasolina 95 E5']?.replace(',','.'),
'Precio Gasolina 98 E5':+s['Precio Gasolina 98 E5']?.replace(',','.'),
'Precio Gasoleo A':+s['Precio Gasoleo A']?.replace(',','.'),
'Precio Gasoleo B':+s['Precio Gasoleo B']?.replace(',','.'),
'Precio Gasoleo Premium':+s['Precio Gasoleo Premium']?.replace(',','.')
}
})));
setLoading(false);
}catch{setError('Error cargando gasolineras')}
};

const loadElec=async()=>{
const r=await fetch('https://api.openchargemap.io/v3/poi/?output=json&countrycode=ES&maxresults=2000');
const d=await r.json();
setChargers(d.map(c=>({
id:'e-'+c.ID,
type:'elec',
name:c.AddressInfo?.Title,
addr:c.AddressInfo?.AddressLine1,
town:c.AddressInfo?.Town,
prov:c.AddressInfo?.StateOrProvince,
lat:c.AddressInfo?.Latitude,
lng:c.AddressInfo?.Longitude,
connections:c.Connections||[]
})));
};

const locateUser=()=>{
navigator.geolocation?.getCurrentPosition(p=>{
const l={lat:p.coords.latitude,lng:p.coords.longitude};
setUserLoc(l);
map.setView([l.lat,l.lng],11);
if(userMarker)userMarker.remove();
userMarker=L.marker([l.lat,l.lng]).addTo(map);
});
};

const dist=(a,b,c,d)=>{
const R=6371;
const dLat=(c-a)*Math.PI/180;
const dLng=(d-b)*Math.PI/180;
const h=Math.sin(dLat/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(dLng/2)**2;
return R*2*Math.atan2(Math.sqrt(h),Math.sqrt(1-h));
};

useEffect(()=>{
if(stations.length){
const p=stations.map(s=>s.prices[fuel]).filter(v=>v>0);
p.length&&setStats({min:Math.min(...p),max:Math.max(...p),avg:p.reduce((a,b)=>a+b,0)/p.length});
}
},[stations,fuel]);

useEffect(()=>{
let res=[];
if(mode==='gas'||mode==='both'){
let g=[...stations].filter(s=>s.prices[fuel]>0);
if(search)g=g.filter(s=>s.name.toLowerCase().includes(search.toLowerCase())||s.town.toLowerCase().includes(search.toLowerCase()));
if(prov)g=g.filter(s=>s.prov===prov);
res=res.concat(g);
}
if(mode==='elec'||mode==='both'){
let e=[...chargers];
if(search)e=e.filter(c=>c.name?.toLowerCase().includes(search.toLowerCase()));
if(prov)e=e.filter(c=>c.prov===prov);
res=res.concat(e);
}
if(sort==='price'&&mode!=='elec')res.sort((a,b)=>(a.prices?.[fuel]||999)-(b.prices?.[fuel]||999));
if(sort==='distance'&&userLoc)res=res.map(i=>({...i,distance:dist(userLoc.lat,userLoc.lng,i.lat,i.lng)})).sort((a,b)=>a.distance-b.distance);
setItems(res.slice(0,1000));
},[stations,chargers,mode,search,fuel,sort,prov,userLoc]);

useEffect(()=>{
if(!mapReady)return;
cluster.clearLayers();
items.forEach(i=>{
if(!i.lat||!i.lng)return;
cluster.addLayer(L.marker([i.lat,i.lng]));
});
},[items,mapReady]);

const toggleCompare=()=>{if(compare)setSelected([]);setCompare(!compare)};
const toggleSel=i=>{
if(i.type!=='gas')return;
selected.find(s=>s.id===i.id)?setSelected(selected.filter(s=>s.id!==i.id)):
selected.length<2?setSelected([...selected,i]):setSelected([selected[1],i]);
};

if(loading)return<div className="sidebar flex items-center justify-center">Cargando…</div>;
if(error)return<div className="sidebar">{error}</div>;

return<>
<div className="sidebar">
<div className="p-4 bg-blue-600 text-white flex justify-between">
<span>⛽ Gasolineras</span>
{mode==='gas'&&<button onClick={toggleCompare}>{compare?'Cerrar':'Comparar'}</button>}
</div>
<div className="p-4">
<input className="w-full border p-2" placeholder="Buscar" value={search} onChange={e=>setSearch(e.target.value)} />
</div>
<div className="sidebar-scroll">
{items.map(i=>(
<div key={i.id} className={`p-3 border-b ${selected.find(s=>s.id===i.id)?'selected-for-compare':''}`}>
<strong>{i.name}</strong>
<div className="text-xs">{i.town} · {i.prov}</div>
{i.type==='gas'&&<div>{i.prices[fuel].toFixed(3)} €/L</div>}
{compare&&i.type==='gas'&&<button onClick={()=>toggleSel(i)}>Seleccionar</button>}
</div>
))}
</div>
</div>

<Comparator stations={selected} fuel={fuel} userLoc={userLoc} onClose={()=>setSelected([])} />
</>;
};

const Comparator=({stations,fuel,userLoc,onClose})=>{
const[amt,setAmt]=useState(50);
const[cons,setCons]=useState(6);
if(stations.length!==2)return null;

const[a,b]=stations;
const p1=a.prices[fuel],p2=b.prices[fuel];
const lDiff=Math.abs(amt/p1-amt/p2);
const saving=lDiff*Math.min(p1,p2);

return(
<div className="comparator-panel open">
<div className="p-4 bg-purple-600 text-white flex justify-between">
<span>⚖️ Comparador</span>
<button onClick={onClose}>×</button>
</div>
<div className="p-4">
<div>{a.name}: {p1.toFixed(3)}€</div>
<div>{b.name}: {p2.toFixed(3)}€</div>
<div className="font-bold mt-2">Ahorro: {saving.toFixed(2)}€</div>
</div>
</div>
);
};

ReactDOM.render(<App/>,document.getElementById('root'));
</script>
</body>
</html>
